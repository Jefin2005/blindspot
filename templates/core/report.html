{% extends 'base.html' %}
{% load static %}

{% block title %}Report an Issue - The Blindspot Initiative{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h1 class="report-title">
            <i class="fa-solid fa-bullhorn" style="color: var(--color-critical);"></i>
            Report a Civic Issue
        </h1>
        <p class="report-subtitle">Help expose neglect in your community. Your report matters.</p>
    </div>

    <form class="report-form" id="report-form">
        {% csrf_token %}

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="category">Issue Category *</label>
                <select name="category_id" id="category" class="form-select" required>
                    <option value="">Select a category...</option>
                    {% regroup categories by authority as authority_list %}
                    {% for authority in authority_list %}
                    <optgroup label="{{ authority.grouper.name }}">
                        {% for category in authority.list %}
                        <option value="{{ category.id }}" data-severity="{{ category.default_severity }}">
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="title">Issue Title *</label>
                <input type="text" name="title" id="title" class="form-input"
                    placeholder="Brief description of the issue" required maxlength="200">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="description">Detailed Description *</label>
            <textarea name="description" id="description" class="form-input form-textarea"
                placeholder="Describe the issue in detail. Include any relevant information that could help authorities address it."
                required></textarea>
        </div>

        <div class="form-group">
            <label class="form-label" for="address">Location / Address *</label>
            <input type="text" name="address" id="address" class="form-input"
                placeholder="Street name, landmark, or area" required>
        </div>

        <div class="form-group">
            <label class="form-label">Pin Location on Map *</label>
            <div class="location-picker" id="location-picker"></div>
            <p class="form-help">Click on the map to set the issue location. <span id="coords-display"></span></p>
            <input type="hidden" name="latitude" id="latitude" required>
            <input type="hidden" name="longitude" id="longitude" required>
        </div>

        <div class="form-group">
            <label class="form-label">Severity Level</label>
            <div class="severity-selector">
                <label class="severity-option" data-value="1">
                    <input type="radio" name="severity" value="1">
                    <div class="severity-number" style="color: var(--color-recent);">1</div>
                    <div class="severity-label">Minor</div>
                </label>
                <label class="severity-option" data-value="2">
                    <input type="radio" name="severity" value="2">
                    <div class="severity-number" style="color: var(--color-recent);">2</div>
                    <div class="severity-label">Low</div>
                </label>
                <label class="severity-option active" data-value="3">
                    <input type="radio" name="severity" value="3" checked>
                    <div class="severity-number" style="color: var(--color-moderate);">3</div>
                    <div class="severity-label">Moderate</div>
                </label>
                <label class="severity-option" data-value="4">
                    <input type="radio" name="severity" value="4">
                    <div class="severity-number" style="color: var(--color-serious);">4</div>
                    <div class="severity-label">High</div>
                </label>
                <label class="severity-option" data-value="5">
                    <input type="radio" name="severity" value="5">
                    <div class="severity-number" style="color: var(--color-critical);">5</div>
                    <div class="severity-label">Critical</div>
                </label>
            </div>
        </div>

        <button type="submit" class="btn btn-primary auth-submit">
            <i class="fa-solid fa-paper-plane"></i> Submit Report
        </button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize mini map for location picker
        const miniMap = L.map('location-picker').setView([9.9312, 76.2673], 13);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OSM',
            maxZoom: 19
        }).addTo(miniMap);

        let locationMarker = null;

        miniMap.on('click', function (e) {
            const lat = e.latlng.lat.toFixed(7);
            const lng = e.latlng.lng.toFixed(7);

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            document.getElementById('coords-display').textContent = `Selected: ${lat}, ${lng}`;

            if (locationMarker) {
                locationMarker.setLatLng(e.latlng);
            } else {
                locationMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'issue-marker urgency-critical',
                        html: '<i class="fa-solid fa-map-pin"></i>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    })
                }).addTo(miniMap);
            }
        });

        // Try to get user location
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(function (pos) {
                miniMap.setView([pos.coords.latitude, pos.coords.longitude], 15);
            });
        }

        // Severity selector
        document.querySelectorAll('.severity-option').forEach(option => {
            option.addEventListener('click', function () {
                document.querySelectorAll('.severity-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                this.querySelector('input').checked = true;
            });
        });

        // Category change - update default severity
        document.getElementById('category').addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            const defaultSeverity = selected.dataset.severity;
            if (defaultSeverity) {
                document.querySelectorAll('.severity-option').forEach(o => o.classList.remove('active'));
                const option = document.querySelector(`.severity-option[data-value="${defaultSeverity}"]`);
                if (option) {
                    option.classList.add('active');
                    option.querySelector('input').checked = true;
                }
            }
        });

        // Form submission
        document.getElementById('report-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = {
                category_id: document.getElementById('category').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                address: document.getElementById('address').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                severity: document.querySelector('input[name="severity"]:checked').value
            };

            if (!formData.latitude || !formData.longitude) {
                alert('Please click on the map to set the issue location.');
                return;
            }

            try {
                const response = await fetch('/report/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('Issue reported successfully! Thank you for making a difference.');
                    window.location.href = '/';
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to submit report. Please try again.');
            }
        });
    });
</script>
{% endblock %}